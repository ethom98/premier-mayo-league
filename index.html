<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Premier Mayo League — Custom H2H</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    h1 { margin-top: 0; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); background:#fff; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px; border-bottom: 1px solid #e5e7eb; text-align: left; }
    th { background: #f9fafb; }
    .muted { color: #6b7280; font-size: 12px; }
    .row { margin: 16px 0; display:flex; gap:12px; align-items:center;}
    input, select, button { padding: 8px 10px; border-radius: 8px; border: 1px solid #e5e7eb; }
    button { cursor: pointer; }
  </style>
</head>
<body>
  <h1>Premier Mayo League — Custom H2H</h1>
  <div class="muted">This site reads JSON in <code>/data</code> generated by the GitHub Action that runs <code>fpl_h2h.py</code>.</div>

 <div class="row">
  <label>Gameweek:
    <input type="number" id="gw" value="1" min="1" style="width:90px">
  </label>
  <label style="display:flex;align-items:center;gap:6px;">
    <input type="checkbox" id="showAll"> Show all GWs
  </label>
  <button onclick="loadGW()">Load</button>
  <span id="sched-status" class="muted"></span>
</div>


  <div class="grid">
    <div class="card">
      <h3>Results</h3>
      <table id="results"><thead><tr><th>Match</th><th>Score</th><th>Status</th></tr></thead><tbody></tbody></table>
    </div>
    <div class="card">
      <h3>Standings</h3>
      <table id="table"><thead><tr><th>Team</th><th>P</th><th>W</th><th>D</th><th>L</th><th>PF</th><th>PA</th><th>Pts</th></tr></thead><tbody></tbody></table>
    </div>
    <div class="card">
      <h3>Schedule</h3>
      <table id="schedule"><thead><tr><th>GW</th><th>Home</th><th>Away</th></tr></thead><tbody></tbody></table>
    </div>

    <!-- NEW: Winnings -->
    <div class="card">
      <h3>Winnings</h3>
      <table id="winnings"><thead>
        <tr><th>Team</th><th>Total Winnings ($)</th><th>Kits Won</th></tr>
      </thead><tbody></tbody></table>
      <div class="muted" id="winnings-note"></div>
    </div>

    <!-- NEW: Mystery Kit Leaders -->
    <div class="card">
      <h3>Mystery Kit Leaders</h3>
      <div id="kits"></div>
      <div class="muted">Blocks: GW1–10, 11–20, 21–30, 31–38</div>
    </div>
  </div>

<script>
async function loadGW() {
  var gw = Number(document.getElementById('gw').value);

  // --- Load core data with safe fallbacks ---
  var sched = { matches: [] };
  try {
    sched = await fetch('data/schedule.json').then(function(r){ return r.json(); });
  } catch (e) {
    console.warn('No schedule.json yet:', e);
  }

  var results = await fetch('data/gw_' + gw + '_results.json')
    .then(function(r){ return r.json(); })
    .catch(function(){ return {gw: gw, matches: [], note: "No results yet"}; });

  var standings = await fetch('data/standings.json')
    .then(function(r){ return r.json(); })
    .catch(function(){ return {teams: []}; });

  // id -> name map (used by Mystery Kits table)
  var idToName = {};
  (standings.teams || []).forEach(function(t){
    if (t.entry_id) idToName[t.entry_id] = t.name;
  });

  // ---------------- SCHEDULE (selected GW) ----------------
  var sbody = document.querySelector('#schedule tbody');
  if (sbody) {
    sbody.innerHTML = '';
    var rows = (sched.matches || []).filter(function(x){ return Number(x.gw) === gw; });

    if (!sched.matches || sched.matches.length === 0) {
      sbody.innerHTML = '<tr><td colspan="3" class="muted">No schedule.json found yet. Re-run the Action or check that fpl_h2h.py wrote data/schedule.json.</td></tr>';
    } else if (rows.length === 0) {
      sbody.innerHTML = '<tr><td colspan="3" class="muted">No fixtures for GW ' + gw + '.</td></tr>';
    } else {
      rows.forEach(function(m){
        var tr = document.createElement('tr');
        tr.innerHTML = '<td>' + m.gw + '</td><td>' + m.home_name + '</td><td>' + m.away_name + '</td>';
        sbody.appendChild(tr);
      });
    }
  }

  // ---------------- RESULTS (selected GW) ----------------
  var rbody = document.querySelector('#results tbody');
  if (rbody) {
    rbody.innerHTML = '';
    (results.matches || []).forEach(function(m){
      var tr = document.createElement('tr');
      tr.innerHTML =
        '<td>' + m.home_name + ' vs ' + m.away_name + '</td>' +
        '<td>' + m.home_points + ' - ' + m.away_points + '</td>' +
        '<td>' + (m.status || '') + '</td>';
      rbody.appendChild(tr);
    });
  }

  // ---------------- STANDINGS ----------------
  var tBody = document.querySelector('#table tbody');
  if (tBody) {
    tBody.innerHTML = '';
    (standings.teams || []).forEach(function(t){
      var tr = document.createElement('tr');
      tr.innerHTML =
        '<td>' + t.name + '</td>' +
        '<td>' + t.played + '</td>' +
        '<td>' + t.wins + '</td>' +
        '<td>' + t.draws + '</td>' +
        '<td>' + t.losses + '</td>' +
        '<td>' + t.points_for + '</td>' +
        '<td>' + t.points_against + '</td>' +
        '<td>' + t.points + '</td>';
      tBody.appendChild(tr);
    });
  }

  // ---------------- WINNINGS (optional) ----------------
  var wTable = document.querySelector('#winnings tbody');
  var wNote = document.getElementById('winnings-note');
  if (wTable) {
    try {
      var winnings = await fetch('data/winnings.json').then(function(r){ return r.json(); });
      wTable.innerHTML = '';
      var totals = (winnings.totals || []).slice().sort(function(a,b){
        return (b.weekly_winnings || 0) - (a.weekly_winnings || 0);
      });
      totals.forEach(function(row){
        var tr = document.createElement('tr');
        tr.innerHTML =
          '<td>' + row.name + '</td>' +
          '<td>$' + Number(row.weekly_winnings || 0).toFixed(2) + '</td>' +
          '<td>' + (row.kits_won || 0) + '</td>';
        wTable.appendChild(tr);
      });
      if (wNote) {
        var perGW = (winnings.weekly && winnings.weekly[0] && winnings.weekly[0].pot_per_gw) ? winnings.weekly[0].pot_per_gw : 10;
        wNote.textContent = 'Weekly top scorer pays $' + perGW + ' per GW.';
      }
    } catch (e) {
      wTable.innerHTML = '<tr><td colspan="3" class="muted">No winnings data yet.</td></tr>';
      if (wNote) wNote.textContent = '';
    }
  }

  // ---------------- MYSTERY KITS (optional) ----------------
  var kitsDiv = document.getElementById('kits');
  if (kitsDiv) {
    try {
      var kits = await fetch('data/mystery_kits.json').then(function(r){ return r.json(); });
      kitsDiv.innerHTML = '';
      (kits.blocks || []).forEach(function(b){
        // Build leaders lines first
        var leaderLines = (b.leaders || [])
          .sort(function(a,b_){ return (b_.total_points || 0) - (a.total_points || 0); })
          .map(function(l){
            var nm = idToName[l.entry_id] || l.entry_id;
            return nm + ' — ' + l.total_points + ' pts (best GW: ' + l.best_single_gw + ')';
          });
        // Winners names
        var winners = (b.winners || []).map(function(eid){ return idToName[eid] || eid; });

        var div = document.createElement('div');
        div.style.marginBottom = '12px';
        div.innerHTML =
          '<div style="font-weight:600">' + b.name + ' (GW' + b.gw_start + '–' + b.gw_end + ')</div>' +
          '<div>Status: ' + b.status + '</div>' +
          '<div>Leaders: ' + (leaderLines.length ? leaderLines.join('<br>') : '—') + '</div>' +
          (b.status === 'complete'
            ? ('<div>Winner' + (winners.length>1?'s':'') + ': ' + (winners.length ? winners.join(', ') : '—') + '</div>')
            : '') +
          (b.note ? ('<div class="muted">' + b.note + '</div>') : '') +
          '<hr>';
        kitsDiv.appendChild(div);
      });
    } catch (e) {
      kitsDiv.innerHTML = '<div class="muted">No mystery kit data yet.</div>';
    }
  }
}

loadGW();
</script>
