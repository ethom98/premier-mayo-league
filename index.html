<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Premier Mayo League — Custom H2H</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    h1 { margin-top: 0; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); background:#fff; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px; border-bottom: 1px solid #e5e7eb; text-align: left; }
    th { background: #f9fafb; }
    .muted { color: #6b7280; font-size: 12px; }
    .row { margin: 16px 0; display:flex; gap:12px; align-items:center;}
    input, select, button { padding: 8px 10px; border-radius: 8px; border: 1px solid #e5e7eb; }
    button { cursor: pointer; }
  </style>
</head>
<body>
  <h1>Premier Mayo League — Custom H2H</h1>
  <div class="muted">This site reads JSON in <code>/data</code> generated by the GitHub Action that runs <code>fpl_h2h.py</code>.</div>

 <div class="row">
  <label>Gameweek:
    <input type="number" id="gw" value="1" min="1" style="width:90px">
  </label>
  <label style="display:flex;align-items:center;gap:6px;">
    <input type="checkbox" id="showAll"> Show all GWs
  </label>
  <button onclick="loadGW()">Load</button>
  <span id="sched-status" class="muted"></span>
</div>


  <div class="grid">
    <div class="card">
      <h3>Results</h3>
      <table id="results"><thead><tr><th>Match</th><th>Score</th><th>Status</th></tr></thead><tbody></tbody></table>
    </div>
    <div class="card">
      <h3>Standings</h3>
      <table id="table"><thead><tr><th>Team</th><th>P</th><th>W</th><th>D</th><th>L</th><th>PF</th><th>PA</th><th>Pts</th></tr></thead><tbody></tbody></table>
    </div>
    <div class="card">
      <h3>Schedule</h3>
      <table id="schedule"><thead><tr><th>GW</th><th>Home</th><th>Away</th></tr></thead><tbody></tbody></table>
    </div>

    <!-- NEW: Winnings -->
    <div class="card">
      <h3>Winnings</h3>
      <table id="winnings"><thead>
        <tr><th>Team</th><th>Total Winnings ($)</th><th>Kits Won</th></tr>
      </thead><tbody></tbody></table>
      <div class="muted" id="winnings-note"></div>
    </div>

    <!-- NEW: Mystery Kit Leaders -->
    <div class="card">
      <h3>Mystery Kit Leaders</h3>
      <div id="kits"></div>
      <div class="muted">Blocks: GW1–10, 11–20, 21–30, 31–38</div>
    </div>
  </div>

<script>
async function loadGW() {
  const gw = Number(document.getElementById('gw').value);

  // Load core data
  const [sched, results, standings] = await Promise.all([
    fetch('data/schedule.json').then(r=>r.json()),
    fetch(`data/gw_${gw}_results.json`).then(r=>r.json()).catch(_=>({gw, matches:[], note:"No results yet"})),
    fetch('data/standings.json').then(r=>r.json()).catch(_=>({teams:[]}))
  ]);

  // Build a quick entry_id -> name map from standings (used by kits table)
  const idToName = {};
  for (const t of (standings.teams || [])) {
    if (t.entry_id) idToName[t.entry_id] = t.name;
  }

// --- Schedule (filter to selected GW unless "Show all" is checked) ---
const sbody = document.querySelector('#schedule tbody');
const statusEl = document.getElementById('sched-status');
sbody.innerHTML = '';
statusEl.textContent = '';

const showAll = document.getElementById('showAll')?.checked;
let rows = (sched.matches || []);
if (!showAll) rows = rows.filter(x => Number(x.gw) === gw);

if (!sched.matches || sched.matches.length === 0) {
  sbody.innerHTML = `<tr><td colspan="3" class="muted">No schedule.json found yet. Re-run the Action or check that fpl_h2h.py wrote data/schedule.json.</td></tr>`;
  statusEl.textContent = '';
} else if (rows.length === 0) {
  sbody.innerHTML = `<tr><td colspan="3" class="muted">No fixtures for GW ${gw}. Tick "Show all GWs" to view full schedule.</td></tr>`;
  statusEl.textContent = `Found ${sched.matches.length} total fixtures`;
} else {
  for (const m of rows) {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${m.gw}</td><td>${m.home_name}</td><td>${m.away_name}</td>`;
    sbody.appendChild(tr);
  }
  statusEl.textContent = showAll
    ? `Showing all ${rows.length} fixtures`
    : `Showing ${rows.length} fixture(s) for GW ${gw}`;
}

  // ----- Results for selected GW -----
  const rbody = document.querySelector('#results tbody');
  rbody.innerHTML = '';
  for (const m of (results.matches || [])) {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${m.home_name} vs ${m.away_name}</td>
                    <td>${m.home_points} - ${m.away_points}</td>
                    <td>${m.status || ''}</td>`;
    rbody.appendChild(tr);
  }

  // ----- Standings -----
  const tbody = document.querySelector('#table tbody');
  tbody.innerHTML = '';
  for (const t of (standings.teams || [])) {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${t.name}</td><td>${t.played}</td><td>${t.wins}</td><td>${t.draws}</td>
                    <td>${t.losses}</td><td>${t.points_for}</td><td>${t.points_against}</td><td>${t.points}</td>`;
    tbody.appendChild(tr);
  }

  // ----- Winnings (reads data/winnings.json) -----
  try {
    const winnings = await fetch('data/winnings.json').then(r=>r.json());
    // winnings = { currency, weekly: [...], totals: [{entry_id,name,weekly_winnings,kits_won}, ...] }
    const wtbody = document.querySelector('#winnings tbody');
    const wnote  = document.querySelector('#winnings-note');
    wtbody.innerHTML = '';

    const totals = (winnings.totals || []).slice().sort((a,b)=> (b.weekly_winnings||0) - (a.weekly_winnings||0));
    for (const row of totals) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${row.name}</td>
                      <td>$${Number(row.weekly_winnings||0).toFixed(2)}</td>
                      <td>${row.kits_won || 0}</td>`;
      wtbody.appendChild(tr);
    }
    wnote.textContent = `Weekly top scorer pays $${(winnings?.weekly?.[0]?.pot_per_gw ?? 10)} per GW.`;
  } catch (e) {
    const wtbody = document.querySelector('#winnings tbody');
    wtbody.innerHTML = '<tr><td colspan="3" class="muted">No winnings data yet.</td></tr>';
  }

  // ----- Mystery Kits (reads data/mystery_kits.json) -----
  try {
    const kits = await fetch('data/mystery_kits.json').then(r=>r.json());
    // kits = { blocks: [{index,name,gw_start,gw_end,status,leaders:[{entry_id,total_points,best_single_gw}], current_top_total, winners:[entry_id], tiebreak_used, note}, ...] }
    const container = document.getElementById('kits');
    container.innerHTML = '';

    for (const b of (kits.blocks || [])) {
      // Turn IDs into names for leaders & winners
      const leaderLines = (b.leaders || [])
        .sort((a,b_) => (b_.total_points||0) - (a.total_points||0))
        .map(l => {
          const nm = idToName[l.entry_id] || l.entry_id;
          return `${nm} — ${l.total_points} pts (best GW: ${l.best_single_gw})';
        });

      const winners = (b.winners || []).map(eid => idToName[eid] || eid);

      const div = document.createElement('div');
      div.style.marginBottom = '12px';
      div.innerHTML = `
        <div style="font-weight:600">${b.name} (GW${b.gw_start}–${b.gw_end})</div>
        <div>Status: ${b.status}</div>
        <div>Leaders: ${leaderLines.length ? leaderLines.join('<br>') : '—'}</div>
        ${b.status === 'complete'
            ? `<div>Winner${winners.length>1?'s':''}: ${winners.length ? winners.join(', ') : '—'}</div>`
            : ''
        }
        ${b.note ? `<div class="muted">${b.note}</div>` : ''}
        <hr>
      `;
      container.appendChild(div);
    }
  } catch (e) {
    const container = document.getElementById('kits');
    container.innerHTML = '<div class="muted">No mystery kit data yet.</div>';
  }
}
loadGW();
</script>
</body>
</html>
